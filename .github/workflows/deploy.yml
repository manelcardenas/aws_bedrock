name: Deploy CDK IMAGE GENERATION Infrastructure  # Workflow name shown in GitHub Actions tab

on: # TRIGGERS - when this workflow runs
  push:
    branches: [ main ]  # ğŸš€ Deploy to PROD when pushing to main
    paths: [ 'infra_images/**' ]  # Only when CDK code changes
  pull_request:
    branches: [ main ]  # ğŸ‘€ Preview changes on PRs
    paths: [ 'infra_images/**' ]

jobs: # JOBS - what actually runs
  deploy:
    runs-on: ubuntu-latest # Use GitHub's Ubuntu server
    environment: production  # ğŸ”’ GitHub environment protection
    
    steps: # STEPS - executed in order
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4 # Checkout the repository
      
    - name: ğŸŸ¢ Setup Node.js (for CDK)
      uses: actions/setup-node@v4 # Setup Node.js
      with:
        node-version: '20'
        
    - name: ğŸ Setup Python (for Lambda)
      uses: actions/setup-python@v4 # Setup Python
      with:
        python-version: '3.12'
        
    - name: ğŸ“¦ Install AWS CDK
      run: npm install -g aws-cdk # Install AWS CDK
        
    - name: ğŸ” Set AWS credentials as environment variables
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-west-2
      run: |
        echo "AWS credentials configured via environment variables"
        aws sts get-caller-identity  # Verify credentials work
        
    - name: ğŸ“š Install Python dependencies
      working-directory: ./infra_images
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ‘€ Preview changes (PR only)
      if: github.event_name == 'pull_request'
      working-directory: ./infra_images
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-west-2
      run: |
        echo "ğŸ” Showing what will change:"
        cdk diff
        
    - name: ğŸ’¾ Backup current stack (for rollback)
      if: github.ref == 'refs/heads/main'
      working-directory: ./infra_images
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-west-2
      run: |
        echo "ğŸ’¾ Creating backup of current stack..."
        aws cloudformation describe-stacks --stack-name InfraImagesStack > stack-backup.json || echo "No existing stack to backup"
        
    - name: ğŸš€ Deploy to Production (main branch only)
      if: github.ref == 'refs/heads/main'
      working-directory: ./infra_images
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-west-2
      run: |
        echo "ğŸš€ Deploying to production..."
        # Deploy with rollback on failure
        if cdk deploy --require-approval never; then
          echo "âœ… Production deployment complete!"
        else
          echo "âŒ Deployment failed! Check logs for details."
          echo "ğŸ”„ Consider manual rollback if needed"
          exit 1
        fi