name: Deploy Frontend Infrastructure

on: # TRIGGERS - when this workflow runs
  push:
    branches: [main] # ğŸš€ Deploy to PROD when pushing to main
    paths:
      - "infra_frontend/**" # When frontend CDK code changes
      - "src/frontend/**" # When frontend static files change

jobs: # JOBS - what actually runs
  deploy:
    runs-on: ubuntu-latest # Use GitHub's Ubuntu server
    environment: production # ğŸ”’ GitHub environment protection

    steps: # STEPS - executed in order
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4 # Checkout the repository

      - name: ğŸŸ¢ Setup Node.js (for CDK)
        uses: actions/setup-node@v4 # Setup Node.js
        with:
          node-version: "20"

      - name: ğŸ Setup Python (for CDK)
        uses: actions/setup-python@v4 # Setup Python
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install AWS CDK
        run: npm install -g aws-cdk # Install AWS CDK

      - name: ğŸ” Configure AWS credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: |
          echo "AWS credentials configured via environment variables"
          echo "Region: us-west-2 (CloudFront is global, region doesn't matter)"
          aws sts get-caller-identity  # Verify credentials work

      - name: ğŸ“š Install Python dependencies
        working-directory: ./infra_frontend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—ï¸ Bootstrap CDK (if needed)
        working-directory: ./infra_frontend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: |
          echo "ğŸ—ï¸ Checking if CDK bootstrap is needed..."
          cdk bootstrap --context env_name=prod || echo "Bootstrap might already exist"

      - name: ğŸ” Show deployment preview
        working-directory: ./infra_frontend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: cdk diff --context env_name=prod || true # Show diff but don't fail if no changes

      - name: ğŸ’¾ Backup current stack (for rollback)
        if: github.ref == 'refs/heads/main'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: |
          echo "ğŸ’¾ Creating backup of current stack..."
          aws cloudformation describe-stacks --stack-name prod-FrontendStack > stack-backup.json || echo "No existing stack to backup"

      - name: ğŸš€ Deploy to Production (main branch only)
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra_frontend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: |
          echo "ğŸš€ Deploying frontend to production..."
          # Deploy with rollback on failure
          if cdk deploy --context env_name=prod --require-approval never; then
            echo "âœ… Frontend deployment complete!"
            echo "ğŸŒ CloudFront distribution deployed successfully"
            echo "ğŸ“¦ Static files uploaded to S3"
            echo "âš¡ Cache invalidation in progress"
          else
            echo "âŒ Deployment failed! Check logs for details."
            echo "ğŸ”„ Consider manual rollback if needed"
            exit 1
          fi

      - name: ğŸ“Š Get deployment outputs
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra_frontend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: |
          echo "ğŸ“Š Deployment Outputs:"
          aws cloudformation describe-stacks \
            --stack-name prod-FrontendStack \
            --query 'Stacks[0].Outputs' \
            --output table || echo "Could not retrieve stack outputs"
