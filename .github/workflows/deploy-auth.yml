name: Deploy Auth & Proxy Infrastructure

on: # TRIGGERS - when this workflow runs
  push:
    branches: [main] # ğŸš€ Deploy to PROD when pushing to main
    paths: ["infra_auth_stack/**"] # Only when auth stack CDK code changes

jobs: # JOBS - what actually runs
  deploy:
    runs-on: ubuntu-latest # Use GitHub's Ubuntu server
    environment: production # ğŸ”’ GitHub environment protection

    steps: # STEPS - executed in order
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4 # Checkout the repository

      - name: ğŸŸ¢ Setup Node.js (for CDK)
        uses: actions/setup-node@v4 # Setup Node.js
        with:
          node-version: "20"

      - name: ğŸ Setup Python (for Lambda)
        uses: actions/setup-python@v4 # Setup Python
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install AWS CDK
        run: npm install -g aws-cdk # Install AWS CDK

      - name: ğŸ” Set AWS credentials as environment variables
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-west-3
        run: |
          echo "AWS credentials configured via environment variables"
          aws sts get-caller-identity  # Verify credentials work

      - name: ğŸ”§ Configure environment variables
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          IMAGE_API_URL: ${{ secrets.IMAGE_API_URL }}
          IMAGE_API_KEY: ${{ secrets.IMAGE_API_KEY }}
          TEXT_API_URL: ${{ secrets.TEXT_API_URL }}
          TEXT_API_KEY: ${{ secrets.TEXT_API_KEY }}
        run: |
          echo "ğŸ”§ Configuring Lambda environment variables from GitHub secrets..."
          # Verify all required secrets are present
          if [ -z "$JWT_SECRET" ]; then echo "âŒ JWT_SECRET not set!"; exit 1; fi
          if [ -z "$IMAGE_API_URL" ]; then echo "âŒ IMAGE_API_URL not set!"; exit 1; fi
          if [ -z "$IMAGE_API_KEY" ]; then echo "âŒ IMAGE_API_KEY not set!"; exit 1; fi
          if [ -z "$TEXT_API_URL" ]; then echo "âŒ TEXT_API_URL not set!"; exit 1; fi
          if [ -z "$TEXT_API_KEY" ]; then echo "âŒ TEXT_API_KEY not set!"; exit 1; fi
          echo "âœ… All required secrets are configured"

      - name: ğŸ“š Install Python dependencies
        working-directory: ./infra_auth_stack
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Show deployment preview
        working-directory: ./infra_auth_stack
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          IMAGE_API_URL: ${{ secrets.IMAGE_API_URL }}
          IMAGE_API_KEY: ${{ secrets.IMAGE_API_KEY }}
          TEXT_API_URL: ${{ secrets.TEXT_API_URL }}
          TEXT_API_KEY: ${{ secrets.TEXT_API_KEY }}
        run: cdk diff || true # Show diff but don't fail if no changes

      - name: ğŸ”§ Bootstrap CDK (if needed)
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra_auth_stack
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-west-3
        run: |
          echo "ğŸ”§ Ensuring CDK is bootstrapped in eu-west-3..."
          cdk bootstrap || echo "âš ï¸ Bootstrap failed or already exists, continuing..."

      - name: ğŸ’¾ Backup current stack (for rollback)
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra_auth_stack
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-west-3
        run: |
          echo "ğŸ’¾ Creating backup of current stack..."
          aws cloudformation describe-stacks --stack-name InfraAuthStack > stack-backup.json || echo "No existing stack to backup"

      - name: ğŸš€ Deploy to Production (main branch only)
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra_auth_stack
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-west-3
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          IMAGE_API_URL: ${{ secrets.IMAGE_API_URL }}
          IMAGE_API_KEY: ${{ secrets.IMAGE_API_KEY }}
          TEXT_API_URL: ${{ secrets.TEXT_API_URL }}
          TEXT_API_KEY: ${{ secrets.TEXT_API_KEY }}
        run: |
          echo "ğŸš€ Deploying auth & proxy stack to production..."
          # Deploy with rollback on failure
          if cdk deploy --require-approval never; then
            echo "âœ… Auth & proxy deployment complete!"
            echo "ğŸ” DynamoDB users table created/updated"
            echo "ğŸ”‘ Auth Lambda deployed (login handler)"
            echo "ğŸ”„ Proxy Lambda deployed (API key protection)"
            echo "ğŸŒ API Gateway endpoints configured"
          else
            echo "âŒ Deployment failed! Check logs for details."
            echo "ğŸ”„ Consider manual rollback if needed"
            exit 1
          fi

      - name: ğŸ“Š Get deployment outputs
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra_auth_stack
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-west-3
        run: |
          echo "ğŸ“Š Deployment Outputs:"
          aws cloudformation describe-stacks \
            --stack-name InfraAuthStack \
            --query 'Stacks[0].Outputs' \
            --output table || echo "Could not retrieve stack outputs"
